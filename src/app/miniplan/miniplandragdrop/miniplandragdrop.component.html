<div class="p-2">
  <app-miniplan-controle [planBase]="MiniplanBase" (einteilen)="neuEinteilen();">
  </app-miniplan-controle>
  <!--Plan-->
  <div class="conatiner" *ngIf="userService.has('api.view_messe');">
    <div class="row">
      <div
        [ngClass]="{'col-md-8':userService.has(['api.view_gruppe', 'api.view_plan']), 'col-12':!userService.has(['api.view_gruppe', 'api.view_plan'])}">
        <!--Neue Gruppe-->
        <div *ngIf="userService.has(['api.add_gruppe', 'api.change_gruppe']);">
          <h2>Neue Gruppe</h2>
          <!--Chips mit Autocomplete-->
          <app-mini-auswahl [minis]="chips_minis" matLabelSetting="Neue Gruppe"></app-mini-auswahl>
          <p><button mat-stroked-button (click)="gruppeAuffuellen();"  matTooltip="Geschwister werden hinzugefügt">Automatisch</button>
            <button class="ms-2" (click)="erstelle_Gruppe();" mat-raised-button color="primary">Erstellen</button></p>
        </div>
        <!--Ende-->
        <h2>Miniplan</h2>
        <p><mat-progress-bar *ngIf="Messen.length !== MiniplanBase.AnzahlMessen" mode="determinate" [value]="(Messen.length / MiniplanBase.AnzahlMessen) * 100"></mat-progress-bar></p>
        <div cdkDropListGroup>
          <div cdkDropListGroup>
            <ng-container *ngFor="let messe of Messen; index as idx_Messe;">
              <!--Kopf der der Messe-->
              <!--Für die Wochenanzeige-->
              <div class="container m-0 p-0" style="max-width: 500px;">
                <div class="row">
                  <div class="d-flex flex-row">
                    <span class="m-2 h6">
                      <ng-container *ngIf="gdService.gd_List_Inst[messe]?.autogenerated; else headMesse;">
                        {{gdService.gd_List_Inst[messe].Datum|showDate}} - {{gdService.gd_List_Inst[messe].Datum|showDate:6}}
                      </ng-container>
                      <!--Für die einzelne Messe-->
                      <ng-template #headMesse>
                        {{gdService.gd_List_Inst[messe]?.Datum|showDate}} - {{gdService.getTextDay(gdService.gd_List_Inst[messe]?.Datum)}}
                        <ng-container *ngIf="gdService.gd_List_Inst[messe]?.Zeit == null; else zeitAnzeige;">
                          {{gdService.gd_Art_List_Inst[gdService.gd_List_Inst[messe]?.Art]?.Zeit}}
                        </ng-container><ng-template #zeitAnzeige>{{gdService.gd_List_Inst[messe]?.Zeit}}</ng-template>
                        Uhr
                      </ng-template>
                      <span *ngIf="gdService.gd_List_Inst[messe]?.Info != ''" [ngClass]="['bg-info', 'p-1', 'rounded']">{{gdService.gd_List_Inst[messe]?.Info}}</span>
                    </span>
                    <div class="ms-2" *ngIf="userService.has('api.change_messe')">
                      <button (click)="oeffneDialog(messe)" mat-stroked-button color="warn">Bearbeiten</button>
                      <button class="ms-2" mat-mini-fab color="warn" (click)="loescheMesseVonPlan(messe, idx_Messe);"><mat-icon>delete</mat-icon></button>
                    </div>
                  </div>
                  <p *ngIf="userService.has('api.change_messe')">
                    <mat-chip-listbox multiple *ngIf="gdService.gd_List_Inst[messe]?.autogenerated">
                      <mat-chip-option [selected]="gdService.checkNofity(messe, gdService.MONTAG)" (selectionChange)="gdService.changeNoftify(messe, gdService.MONTAG, $event.source.selected)">Mo</mat-chip-option>
                      <mat-chip-option [selected]="gdService.checkNofity(messe, gdService.DIENSTAG)" (selectionChange)="gdService.changeNoftify(messe, gdService.DIENSTAG, $event.source.selected)">Di</mat-chip-option>
                      <mat-chip-option [selected]="gdService.checkNofity(messe, gdService.MITTWOCH)" (selectionChange)="gdService.changeNoftify(messe, gdService.MITTWOCH, $event.source.selected)">Mi</mat-chip-option>
                      <mat-chip-option [selected]="gdService.checkNofity(messe, gdService.DONNERSTAG)" (selectionChange)="gdService.changeNoftify(messe, gdService.DONNERSTAG, $event.source.selected)">Do</mat-chip-option>
                      <mat-chip-option [selected]="gdService.checkNofity(messe, gdService.FREITAG)" (selectionChange)="gdService.changeNoftify(messe, gdService.FREITAG, $event.source.selected)">Fr</mat-chip-option>
                      <mat-chip-option [selected]="gdService.checkNofity(messe, gdService.SAMSTAG)" (selectionChange)="gdService.changeNoftify(messe, gdService.SAMSTAG, $event.source.selected)">Sa</mat-chip-option>
                      <mat-chip-option [selected]="gdService.checkNofity(messe, gdService.SONTAG)" (selectionChange)="gdService.changeNoftify(messe, gdService.SONTAG, $event.source.selected)">So</mat-chip-option>
                    </mat-chip-listbox>
                  </p>
                </div>
            </div>
              <!--MesseArt Info-->
              <sub
                  *ngIf="userService.has('api.view_messeart')">{{gdService.gd_Art_List_Inst[gdService.gd_List_Inst[messe]?.Art]?.Name}}:
                  Minis insgesamt
                  {{gdService.gd_Art_List_Inst[gdService.gd_List_Inst[messe]?.Art]?.MinisInsgesamt}} Oberminis
                  {{gdService.gd_Art_List[gdService.gd_List_Inst[messe]?.Art]?.OberminisAnzahl}}</sub>
              <!--<p class="m-1">Minis insgesamt: {{gdService.gd_Art_List[messe.Art].MinisInsgesamt}}; Davon Oberminis: {{gdService.gd_Art_List[messe.Art].OberminisAnzahl}}</p>-->
              <!--Gruppen der Messe-->
              <div *ngIf="userService.has('api.view_gruppe'); else noAccessToGruppe;"
                [cdkDropListData]="Gruppen[idx_Messe]" cdkDropList cdkDropListOrientation="horizontal"
                (cdkDropListDropped)="drop($event, messe)"> <!--hier war messe drin-->
                <!--Falls Messe leer ist-->
                <div *ngIf="Gruppen[idx_Messe].length === 0">
                  <mat-card appearance="outlined" class="m-1" style="min-height: 52px;"></mat-card>
                </div>
                <div cdkDrag *ngFor="let gruppen of Gruppen[idx_Messe]; index as idx_Gruppe">
                  <mat-card appearance="outlined" class="m-1" [ngClass]="{'bg-danger':gruppen.state==='error', 'bg-warning':gruppen.state==='warning'}">
                    <mat-card-content> 
                      {{gruppen.Minis|showMinis}}
                      <button style="height: 1em;" class="float-end" mat-button *ngIf="userService.has('api.delete_gruppe');"
                      (click)="miniplanService.ws_removeGruppe([gruppen.id])">Löschen</button>
                    </mat-card-content>
                  </mat-card>
                </div>
              </div>
              <ng-template #noAccessToGruppe>
                <mat-card appearance="outlined"></mat-card>
              </ng-template>
            </ng-container>
          </div>
        </div>
      </div>
      <div class="col-4" *ngIf="userService.has(['api.view_gruppe', 'api.view_plan']);">
        <app-miniplan-statistik [Miniplan]="MiniplanBase"></app-miniplan-statistik>
      </div>
    </div>
  </div>
<ng-container *ngIf="showEditGd">
  <mat-card appearance="outlined" class="fixed-top top-50 start-50 translate-middle" style="position: fixed;">
    <button mat-mini-fab class="position-absolute end-0 me-2" color="primary" (click)="showEditGd=false;"><mat-icon>close</mat-icon></button>
    <app-gd-verwaltung [selectedGdId]="bearbeite_gd_id"></app-gd-verwaltung>
  </mat-card>
</ng-container>
